<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b74ff" />
  <meta name="description" content="Plan je taken, volg prestaties en genereer barcodes" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230b74ff' width='100' height='100'/><text x='50' y='75' font-size='60' text-anchor='middle' fill='white'>üìã</text></svg>" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%230b74ff' width='192' height='192'/><text x='96' y='150' font-size='100' text-anchor='middle' fill='white'>üìã</text></svg>" />
  <title>Supermarkt Takenplanner</title>
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --accent: #0b74ff;
      --accent-dark: #065ecb;
      --border: #e6e9ef;
      --success: #16a34a;
      --danger: #ef4444;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* Header */
    header{
      background: linear-gradient(90deg,var(--accent),var(--accent-dark));
      color: #fff;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 2px 6px rgba(11, 116, 255, 0.12);
    }
    header h1{
      margin:0;
      font-size:1.1rem;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .header-controls{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .icon-btn{
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.08); }

    /* Quick menu (above widgets) */
    .quick-bar{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 0 6px 0;
      /* Zorg dat knoppen op √©√©n regel blijven; laat horizontaal scrollen op smalle schermen */
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    .quick-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(255,255,255,0.06);
      color:var(--text);
      border:1px solid var(--border);
      text-decoration:none;
      font-weight:700;
      cursor:pointer;
      /* compacte icon-knoppen: niet uitrekken, passen bij icon-grootte */
      flex: 0 0 auto;
      min-width: 56px;
      padding:10px;
      font-size:18px;
      box-sizing: border-box;
      white-space: nowrap;
    }
    .quick-btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
    .quick-btn.small{ padding:6px 8px; font-weight:600 }
    /* Layout */
    main{
      flex:1;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width:900px;
      margin:0 auto;
      width:100%;
    }

    /* Card (widget) */
    .card{
      background: var(--card);
      border-radius:12px;
      box-shadow: 0 1px 4px rgba(15,23,42,0.06);
      border:1px solid var(--border);
      overflow:hidden;
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      cursor:pointer;
      user-select:none;
    }
    .card-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:600;
    }
    .card-summary{
      color:var(--muted);
      font-size:0.95rem;
    }
    .card-body{
      padding:12px 14px 16px 14px;
      border-top:1px solid var(--border);
    }
    .hidden { display:none; }

    /* Performance inputs */
    .row {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
      align-items:center;
    }
    label { font-size:0.9rem; color:var(--muted); min-width:110px; }
    input[type="number"], input[type="text"]{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:0.95rem;
      width:100%;
      max-width:240px;
    }
    .btn{
      padding:8px 12px;
      border-radius:10px;
      border:none;
      background:var(--accent);
      color:white;
      cursor:pointer;
      font-weight:600;
    }
    .btn:active{ transform:translateY(1px); }

    /* Tasks */
    .task-list { list-style:none; padding:0; margin:0; }
    .task-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid var(--border);
    }
    .task-item:last-child{ border-bottom:0; }
    .task-item label{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      flex:1;
    }
    .task-item input[type="checkbox"]{ width:18px; height:18px; }
    .task-text{ font-size:0.98rem; }
    .task-text.done{ text-decoration:line-through; color:var(--muted); }
    .task-actions{ display:flex; gap:8px; align-items:center; }
    .small-btn{ background:transparent; border:none; color:var(--muted); font-size:16px; cursor:pointer; padding:6px; border-radius:8px; }
    .small-btn:hover{ background:rgba(0,0,0,0.03); color:var(--danger); }

    /* Add inputs */
    .add-row{ display:flex; gap:8px; margin-top:10px; }
    .add-row input{ flex:1; }

    /* Settings full-screen popup */
    .popup-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.4);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1200;
      padding:18px;
    }
    .popup{
      background:var(--card);
      width:100%;
      max-width:980px;
      max-height:90vh;
      border-radius:8px;
      overflow:hidden;
      position:relative;
      padding:0;
      display:flex;
      flex-direction:column;
    }
    .popup > main {
      flex:1;
      overflow:auto;
      padding:18px;
    }
    .popup header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:sticky;
      top:0;
      background:transparent;
      padding-bottom:8px;
      z-index:10;
      border-bottom:1px solid var(--border);
    }
    .popup .close-btn{
      background:transparent;
      border:none;
      font-size:20px;
      cursor:pointer;
      color:var(--muted);
      padding:6px 8px;
      border-radius:8px;
    }
    .popup .close-btn:hover{ background:rgba(0,0,0,0.03); color:var(--danger); }

    /* Codes widget / barcode popup */
    .code-list { list-style:none; padding:0; margin:0; }
    .code-item { display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); }
    .code-item .meta { flex:1; display:flex; flex-direction:column; }
    .code-item .meta .name { font-weight:600; }
    .code-item .meta .code { font-size:0.95rem; color:var(--muted); }
    .code-actions { display:flex; gap:6px; }
    .btn-small { background:transparent; border:none; font-size:18px; cursor:pointer; padding:6px 8px; border-radius:8px; color:var(--text); transition:all 0.2s; }
    .btn-small:hover { background:rgba(0,0,0,0.05); transform:scale(1.1); }
    .barcode-popup { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:1300; padding:12px; }
    .barcode-box { background:var(--card); padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.3); max-width:420px; width:100%; text-align:center; }
    .barcode-img { max-width:100%; height:auto; display:block; margin:6px auto 0; }
    .copy-btn{ margin-top:8px; display:inline-block; padding:8px 10px; border-radius:8px; background:var(--accent); color:#fff; border:none; cursor:pointer; }
    .close-popup{ background:transparent; border:none; font-size:18px; cursor:pointer; color:var(--muted); }

    /* Performance widget (inklapbaar) */
    #perfCard {
      /* start collapsed */
      max-height: 120px;
      overflow: hidden;
    }
    #perfCard.expanded {
      max-height: 2000px; /* grote waarde voor uitklap-animatie */
      transition: max-height 0.4s ease;
    }

    /* responsive */
    @media (min-width:720px){
      .two-col{ display:flex; gap:12px; }
      .two-col > * { flex:1; }
    }

  </style>
  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>üìã Supermarkt Takenplanner</h1>
    <div class="header-controls">
      <!-- Instellingen (open fullscreen popup) -->
      <button id="openSettings" class="icon-btn" title="Instellingen (standaardtaken)">
        ‚öôÔ∏è
      </button>
    </div>
  </header>

  <main>
    <!-- Quick menu (boven Stuksprestatie) -->
    <div class="quick-bar" id="quickBar">
      <a id="btnApp" class="quick-btn primary" href="intent:#Intent;launchFlags=0x10000000;component=com.lidl.eci.lidlplus/com.lidl.eci.lidlplus.Main;end" target="_blank" rel="noopener" title="Lidl+ app" aria-label="Lidl+ app">üì±</a>
      <a id="btnSite" class="quick-btn" href="https://www.lidl.nl/" target="_blank" rel="noopener" title="Website" aria-label="Website">üåê</a>
      <a id="btnFlyer" class="quick-btn" href="#" target="_blank" rel="noopener" title="Folder" aria-label="Folder">üì∞</a>
      <button id="btnPauze" class="quick-btn" title="Pauze berekenen" aria-label="Pauze berekenen">‚è∏Ô∏è</button>
      <a id="btnCustom2" class="quick-btn small" href="#" target="_blank" rel="noopener" title="Snel 2" aria-label="Snel 2">‚ö°</a>
    </div>
    <!-- Prestatie widget (inklapbaar) -->
    <section class="card" id="perfCard">
      <div class="card-header" id="perfHeader" aria-expanded="false">
        <div class="card-title">üìä Stuksprestatie</div>
        <div class="card-summary" id="perfSummary">Stuks: n.v.t.</div>
      </div>
  <div class="card-body hidden" id="perfBody">
        <div class="two-col">
          <div>
            <div class="row">
              <label for="planInput">Plan vandaag</label>
              <input id="planInput" type="number" inputmode="numeric" placeholder="Bijv. 21000" />
            </div>
            <div class="row">
              <label for="lastWeekTotal">Vorige week (zelfde dag)</label>
              <input id="lastWeekTotal" type="number" inputmode="numeric" placeholder="Bijv. 23000" />
            </div>
          </div>
          <div>
            <div class="row">
              <label for="currentNow">Nu op (vandaag)</label>
              <input id="currentNow" type="number" inputmode="numeric" placeholder="Bijv. 14000" />
            </div>
            <div class="row">
              <label for="twoWeeksAgo">Vorige week op dit moment (2w terug)</label>
              <input id="twoWeeksAgo" type="number" inputmode="numeric" placeholder="Bijv. 15000" />
            </div>
          </div>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="calcPerf">Bereken</button>
          <button class="btn" id="savePerf" style="background:#6b7280;">Opslaan</button>
          <div id="perfResult" style="margin-left:auto; font-weight:700;"></div>
        </div>
      </div>
    </section>

    <!-- Taken widget (inklapbaar) -->
    <section class="card" id="tasksCard">
      <div class="card-header" id="tasksHeader" aria-expanded="false">
        <div class="card-title">‚úÖ Taken</div>
        <div class="card-summary" id="tasksSummary">Taken: 0 / 0 gedaan</div>
      </div>

  <div class="card-body hidden" id="tasksBody">
        <ul class="task-list" id="taskList"></ul>

        <div class="add-row">
          <input id="newTaskInput" type="text" placeholder="Nieuwe dagtaak toevoegen..." />
          <button id="addTaskBtn" class="btn">‚ûï</button>
        </div>
      </div>
    </section>

    <!-- Codes widget (EAN generator / not-working codes) -->
    <section class="card" id="codesCard">
      <div class="card-header" id="codesHeader" aria-expanded="false" style="cursor:pointer;">
        <div class="card-title">üîñ Codes</div>
        <div class="card-summary">Bewaar codes en genereer QR</div>
      </div>
      <div class="card-body hidden" id="codesBody">
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input id="codeInput" type="text" placeholder="Code (numbers)" style="flex:1; max-width:220px;" />
          <input id="codeNameInput" type="text" placeholder="Naam product / opmerking" style="flex:2; min-width:160px;" />
          <button id="addCodeBtn" class="btn">‚ûï</button>
        </div>
        <ul id="codeList" class="code-list" style="margin-top:12px;"></ul>
    </section>

  </main>

  <!-- Fullscreen settings popup -->
  <div id="popup" class="popup-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="popup" role="document">
      <header>
        <div style="display:flex;flex-direction:column;">
          <div style="font-weight:700;">‚öôÔ∏è Instellingen ‚Äî Standaardtaken</div>
          <div class="muted" style="font-size:0.9rem; margin-top:4px;">Beheer taken die elke dienst terugkomen</div>
        </div>
        <div>
          <button id="closePopup" class="close-btn" aria-label="Sluit instellingen">‚úñ</button>
        </div>
      </header>

      <main style="padding:12px;">
        <section style="margin-top:12px;">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
            <input id="newStandardInput" type="text" placeholder="Nieuwe standaardtaak..." />
            <button id="addStandardBtn" class="btn">‚ûï Voeg toe</button>
          </div>

          <ul id="standardList" class="task-list"></ul>

              <div style="margin-top:14px; padding-top:10px; border-top:1px dashed var(--border);">
                <div style="font-weight:700; margin-bottom:8px;">Snelkoppelingen (bovenaan)</div>
                <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                    <input id="appUriInput" type="text" placeholder="App intent/scheme (optioneel) bv. lidlplus://open of intent://..." style="flex:1; max-width:680px;" />
                  </div>
                <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                  <input id="quick2Label" type="text" placeholder="Knop 2 label" style="flex:1; max-width:260px;" />
                  <input id="quick2Url" type="text" placeholder="Knop 2 URL" style="flex:1; max-width:420px;" />
                </div>
                <div style="margin-top:8px; display:flex; gap:8px;">
                  <button id="saveQuickBtn" class="btn">‚úîÔ∏è Opslaan snelkoppelingen</button>
                  <button id="resetQuickBtn" class="small-btn" style="margin-left:8px;color:var(--danger)">Reset snelkoppelingen</button>
                </div>
                <p class="muted" style="margin-top:8px;">Gebruik intent-URL (Android) voor apps, of normale https-links voor websites. Folder-knop gebruikt het huidige weeknummer/jaar.</p>
              </div>

          <div style="margin-top:18px;">
            <button id="closeAndSave" class="btn">‚úîÔ∏è Klaar</button>
            <button id="resetAll" class="small-btn" style="margin-left:8px;color:var(--danger)">Reset alles (clear localStorage)</button>
            <p class="muted" style="margin-top:8px;">Reset alleen gebruiken als je √©cht opnieuw wilt beginnen ‚Äî dit wist alle data.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Barcode popup -->
  <div id="barcodePopup" class="barcode-popup" role="dialog" aria-hidden="true">
    <div class="barcode-box" role="document">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong id="barcodeTitle">Barcode</strong>
        <button id="closeBarcode" class="close-popup" aria-label="Sluit">‚úñ</button>
      </div>
      <div id="barcodeContainer" style="margin-top:8px; text-align:center;">
        <!-- barcode image inserted here -->
      </div>
      <div id="qrcodeContainer" style="margin-top:8px; text-align:center;">
        <!-- QR code inserted here -->
      </div>
    </div>
  </div>

  <!-- Pauze Calculator Popup -->
  <div id="pauzePopup" class="popup-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="popup" role="document" style="max-width:500px;">
      <header>
        <div style="font-weight:700;">‚è∏Ô∏è Pauze Berekenen</div>
        <button id="closePauze" class="close-btn" aria-label="Sluit">‚úñ</button>
      </header>
      <div style="padding:20px;">
        <div class="row">
          <label for="pauzeStart">Starttijd</label>
          <input id="pauzeStart" type="time" />
        </div>
        <div class="row">
          <label for="pauzeEnd">Eindtijd (optioneel)</label>
          <input id="pauzeEnd" type="time" />
        </div>
        <div class="row">
          <label for="pauzePauze">Pauze (minuten)</label>
          <input id="pauzePauze" type="number" placeholder="Bijv. 15" />
        </div>
        <button id="calculatePauze" class="btn" style="width:100%; margin-top:16px;">Berekenen</button>
        <div id="pauzeResult" style="margin-top:16px; padding:12px; background:#f0f0f0; border-radius:8px; text-align:center; display:none;">
          <strong id="pauzeResultText"></strong>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- Keys voor localStorage ----
    const KEY_STANDARD = 'sm_standard_tasks_v1';
    const KEY_DAILY = 'sm_daily_tasks_v1';
    const KEY_PERF = 'sm_perf_v1'; // object met plan,lastWeek,current,twoWeeks en lastSummary
    const KEY_CODES = 'sm_codes_v1';
    const KEY_QUICK = 'sm_quick_v1';
    
    // ---- Elementen ----
    const perfCard = document.getElementById('perfCard');
    const perfHeader = document.getElementById('perfHeader');
    const perfBody = document.getElementById('perfBody');
    const perfSummary = document.getElementById('perfSummary');
    const perfResult = document.getElementById('perfResult');
    const calcPerf = document.getElementById('calcPerf');
    const savePerf = document.getElementById('savePerf');
    
    const planInput = document.getElementById('planInput');
    const lastWeekTotal = document.getElementById('lastWeekTotal');
    const currentNow = document.getElementById('currentNow');
    const twoWeeksAgo = document.getElementById('twoWeeksAgo');

    const tasksCard = document.getElementById('tasksCard');
    const tasksHeader = document.getElementById('tasksHeader');
    const tasksBody = document.getElementById('tasksBody');
    const tasksSummary = document.getElementById('tasksSummary');
    const taskListEl = document.getElementById('taskList');
    const newTaskInput = document.getElementById('newTaskInput');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const clearDaily = document.getElementById('clearDaily');

    const openSettings = document.getElementById('openSettings');
    const popup = document.getElementById('popup');
    const closePopup = document.getElementById('closePopup');
    const addStandardBtn = document.getElementById('addStandardBtn');
    const newStandardInput = document.getElementById('newStandardInput');
    const standardList = document.getElementById('standardList');
    const closeAndSave = document.getElementById('closeAndSave');
    const resetAll = document.getElementById('resetAll');
  // quick menu elements
  const btnApp = document.getElementById('btnApp');
  const btnSite = document.getElementById('btnSite');
  const btnFlyer = document.getElementById('btnFlyer');
  const btnPauze = document.getElementById('btnPauze');
  const btnCustom2 = document.getElementById('btnCustom2');
  const saveQuickBtn = document.getElementById('saveQuickBtn');
  const resetQuickBtn = document.getElementById('resetQuickBtn');
  const quick2Label = document.getElementById('quick2Label');
  const quick2Url = document.getElementById('quick2Url');
  const appUriInput = document.getElementById('appUriInput');
    
    const codeInput = document.getElementById('codeInput');
    const codeNameInput = document.getElementById('codeNameInput');
    const addCodeBtn = document.getElementById('addCodeBtn');
    const codeListEl = document.getElementById('codeList');
    const barcodePopup = document.getElementById('barcodePopup');
    const barcodeContainer = document.getElementById('barcodeContainer');
    const barcodeTitle = document.getElementById('barcodeTitle');
    const closeBarcode = document.getElementById('closeBarcode');
    const copyBarcode = document.getElementById('copyBarcode');
    const codesHeader = document.getElementById('codesHeader');
    const codesBody = document.getElementById('codesBody');
    
    const pauzePopup = document.getElementById('pauzePopup');
    const closePauze = document.getElementById('closePauze');
    const pauzeStart = document.getElementById('pauzeStart');
    const pauzeEnd = document.getElementById('pauzeEnd');
    const pauzePauze = document.getElementById('pauzePauze');
    const calculatePauze = document.getElementById('calculatePauze');
    const pauzeResult = document.getElementById('pauzeResult');
    const pauzeResultText = document.getElementById('pauzeResultText');
    
    // ---- State helpers ----
    function loadStandard(){
      try { return JSON.parse(localStorage.getItem(KEY_STANDARD)) || []; } catch(e) { return []; }
    }
    function loadDaily(){
      try { return JSON.parse(localStorage.getItem(KEY_DAILY)) || []; } catch(e) { return []; }
    }
    function loadPerf(){
      try { return JSON.parse(localStorage.getItem(KEY_PERF)) || {}; } catch(e) { return {}; }
    }
    function loadQuick(){ try { return JSON.parse(localStorage.getItem(KEY_QUICK)) || {}; } catch(e){ return {}; } }
    function saveQuick(obj){ localStorage.setItem(KEY_QUICK, JSON.stringify(obj)); }
    // loadCodes/saveCodes worden verderop in de "Codes storage" sectie gedefinieerd (vermijden van duplicaten)
    function saveStandard(arr){ localStorage.setItem(KEY_STANDARD, JSON.stringify(arr)); }
    function saveDaily(arr){ localStorage.setItem(KEY_DAILY, JSON.stringify(arr)); }
    function savePerfData(obj){ localStorage.setItem(KEY_PERF, JSON.stringify(obj)); }
    // saveCodes is later gedefinieerd in de codes-sectie

    // ---- Utils ----
    function simpleId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

    // --- Quick menu helpers ---
    function getISOWeek(d){
      // returns [week, year]
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
      return [weekNo, date.getUTCFullYear()];
    }

    function getFlyerUrlForDate(d){
      const [week, year] = getISOWeek(d);
      return `https://www.lidl.nl/l/folders/hah-wk${week}-${year}/view/flyer/page/1`;
    }

    function renderQuickMenu(){
      const q = loadQuick();
      // App button keeps a safe href; opening the app is handled by a click handler with fallback
      btnApp.href = q.appHref || btnApp.href || '#';
      if(q.appHref) appUriInput.value = q.appHref;
      // keep the icon, but update accessible label/title if user provided a custom label
      if(q.appLabel) { btnApp.title = q.appLabel; btnApp.setAttribute('aria-label', q.appLabel); }

      // site always points to Lidl
      btnSite.href = q.siteHref || 'https://www.lidl.nl/';
      if(q.siteLabel) { btnSite.title = q.siteLabel; btnSite.setAttribute('aria-label', q.siteLabel); }

      // flyer uses computed week/year unless user overrides
      const flyerHref = q.flyerHref || getFlyerUrlForDate(new Date());
      btnFlyer.href = flyerHref;
      if(q.flyerLabel) { btnFlyer.title = q.flyerLabel; btnFlyer.setAttribute('aria-label', q.flyerLabel); }

      // custom 2
      btnCustom2.href = q.custom2Url || '#';
      btnCustom2.title = q.custom2Label || 'Snel 2';
      btnCustom2.setAttribute('aria-label', q.custom2Label || 'Snel 2');
    }

    // ---- Render standaardtaken in popup ----
    function renderStandardList(){
      const standard = loadStandard();
      standardList.innerHTML = '';
      if(standard.length === 0){
        const p = document.createElement('p'); p.className = 'muted'; p.textContent = 'Geen standaardtaken toegevoegd.';
        standardList.appendChild(p);
        return;
      }
      standard.forEach((t, idx) => {
        const li = document.createElement('li');
        li.className = 'task-item';
        const label = document.createElement('label');
        const span = document.createElement('span');
        span.className = 'task-text';
        span.textContent = t.text;
        label.appendChild(span);
        li.appendChild(label);

        const actions = document.createElement('div'); actions.className='task-actions';
        const delBtn = document.createElement('button');
        delBtn.className = 'small-btn';
        delBtn.innerHTML = '‚úñ';
        delBtn.title = 'Verwijder standaardtaak';
        delBtn.onclick = () => {
          standard.splice(idx,1);
          saveStandard(standard);
          renderStandardList();
          renderTasks(); // update main tasks
        };
        actions.appendChild(delBtn);
        li.appendChild(actions);
        standardList.appendChild(li);
      });
    }

    addStandardBtn.addEventListener('click', () => {
      const text = newStandardInput.value.trim();
      if(!text) return;
      const standard = loadStandard();
      standard.push({ id: simpleId(), text, done:false, standard: true });
      saveStandard(standard);
      newStandardInput.value = '';
      renderStandardList();
      renderTasks();
    });

    // Save quick links
    saveQuickBtn.addEventListener('click', () => {
      const obj = {
        appHref: appUriInput.value.trim() || btnApp.href,
        siteHref: btnSite.href,
        flyerHref: btnFlyer.href,
        custom2Label: quick2Label.value.trim() || 'Snel 2',
        custom2Url: quick2Url.value.trim() || '#'
      };
      saveQuick(obj);
      renderQuickMenu();
      alert('Snelkoppelingen opgeslagen.');
    });

    resetQuickBtn.addEventListener('click', () => {
      if(!confirm('Reset snelkoppelingen naar standaardinstellingen?')) return;
      localStorage.removeItem(KEY_QUICK);
      quick2Label.value = '';
      quick2Url.value = '';
      appUriInput.value = '';
      renderQuickMenu();
    });

    // App open handler: try custom scheme/intent from settings, then intent with fallback, then Play Store
    btnApp.addEventListener('click', (e) => {
      e.preventDefault();
      const playStore = 'https://play.google.com/store/apps/details?id=com.lidl.eci.lidlplus';
      const stored = loadQuick();
      const appUri = (stored && stored.appHref) ? stored.appHref : (appUriInput.value.trim() || '');

      function redirectToStore(){
        window.location.href = playStore;
      }

      // If user provided a custom app URI and it looks like a scheme (no http), try it first
      if(appUri && !/^https?:\/\//i.test(appUri)){
        // Try opening custom scheme (e.g., lidlplus://open)
        try{
          window.location.href = appUri;
        }catch(e){
          // ignore
        }
        // if nothing happened after timeout, go to Play Store
        setTimeout(() => { if(document.visibilityState === 'visible') redirectToStore(); }, 1200);
        return;
      }

      // Otherwise, build intent URI with browser_fallback_url
      const fallback = playStore;
      const intentUri = 'intent://#Intent;package=com.lidl.eci.lidlplus;S.browser_fallback_url=' + encodeURIComponent(fallback) + ';end';
      try{
        window.location.href = intentUri;
      }catch(err){
        redirectToStore();
      }
      setTimeout(() => { if(document.visibilityState === 'visible') redirectToStore(); }, 1200);
    });

    // ---- Tasks rendering (combines standard + daily) ----
    function renderTasks(){
      const standard = loadStandard();
      const daily = loadDaily();
      const all = [...standard, ...daily];
      taskListEl.innerHTML = '';
      if(all.length === 0){
        const p = document.createElement('p'); p.className='muted'; p.textContent='Nog geen taken voor vandaag.';
        taskListEl.appendChild(p);
      } else {
        all.forEach((task, idx) => {
          const li = document.createElement('li');
          li.className = 'task-item';

          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = Boolean(task.done);
          checkbox.onchange = () => {
            toggleTask(idx);
          };

          const span = document.createElement('span');
          span.className = 'task-text';
          span.textContent = task.text;
          if(task.done) span.classList.add('done');

          label.appendChild(checkbox);
          label.appendChild(span);

          li.appendChild(label);

          // delete button only for daily
          const actions = document.createElement('div');
          actions.className = 'task-actions';
          if(!task.standard){
            const del = document.createElement('button');
            del.className = 'small-btn';
            del.innerHTML = 'üóëÔ∏è';
            del.title = 'Verwijder dagtaak';
            del.onclick = () => {
              deleteDaily(idx);
            };
            actions.appendChild(del);
          } else {
            const badge = document.createElement('div');
            badge.className = 'muted';
            badge.style.fontSize = '0.85rem';
            badge.textContent = 'std';
            actions.appendChild(badge);
          }
          li.appendChild(actions);
          taskListEl.appendChild(li);
        });
      }
      updateTasksSummary();
    }

    function updateTasksSummary(){
      const standard = loadStandard();
      const daily = loadDaily();
      const all = [...standard, ...daily];
      const total = all.length;
      const done = all.filter(t => t.done).length;
      tasksSummary.textContent = `Taken: ${done} / ${total} gedaan`;
    }

    // --- Add / toggle / delete tasks ---
    addTaskBtn.addEventListener('click', () => {
      const text = newTaskInput.value.trim();
      if(!text) return;
      const daily = loadDaily();
      daily.push({ id: simpleId(), text, done:false, standard:false });
      saveDaily(daily);
      newTaskInput.value = '';
      renderTasks();
    });

    newTaskInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') addTaskBtn.click();
    });

    function toggleTask(index){
      const standard = loadStandard();
      const daily = loadDaily();
      const all = [...standard, ...daily];
      if(!all[index]) return;
      all[index].done = !all[index].done;
      // split back
      const newStandard = all.filter(t => t.standard);
      const newDaily = all.filter(t => !t.standard);
      saveStandard(newStandard);
      saveDaily(newDaily);
      renderTasks();
    }

    function deleteDaily(index){
      const standard = loadStandard();
      const daily = loadDaily();
      if(index < standard.length){
        // shouldn't happen because delete only shown for daily
        return;
      } else {
        daily.splice(index - standard.length, 1);
        saveDaily(daily);
        renderTasks();
      }
    }

    // ---- Performance logic ----
    function calculatePerformance(){
      const plan = Number(planInput.value || 0);
      const lastWeek = Number(lastWeekTotal.value || 0);
      const now = Number(currentNow.value || 0);
      const twoWeeks = Number(twoWeeksAgo.value || 0);

      if(!plan || !lastWeek || !now || !twoWeeks){
        perfResult.textContent = 'Vul alle velden in.';
        perfResult.className = '';
        return;
      }

      // verschil op dit moment (t.o.v. 2 weken terug op dat moment)
      const verschilNu = now - twoWeeks;
      // prognose = vorige week totaal + verschilNu
      const prognose = lastWeek + verschilNu;
      const verschilPlan = prognose - plan; // positief = boven plan

      // Rondingen en lokale notatie
      function fmt(n){ return Number(n).toLocaleString('nl-NL'); }

      let summaryText = '';
      if(verschilPlan > 0){
        summaryText = `Je komt uit op ${fmt(prognose)} stuks (+${fmt(verschilPlan)} op plan). Goed!`;
        perfSummaryShow(`+${fmt(verschilPlan)}`, true);
        perfResult.className = 'positive';
      } else if(verschilPlan < 0){
        summaryText = `Je komt uit op ${fmt(prognose)} stuks (${fmt(verschilPlan)} op plan).`;
        perfSummaryShow(`${fmt(verschilPlan)}`, false);
        perfResult.className = 'negative';
      } else {
        summaryText = `Prognose ${fmt(prognose)} stuks (exact op plan).`;
        perfSummaryShow('0', true);
        perfResult.className = '';
      }

      perfResult.textContent = summaryText;

      // return an object to save
      return {
        plan, lastWeek, now, twoWeeks,
        prognose, verschilPlan
      };
    }

    function perfSummaryShow(text, positive){
      perfSummary.textContent = (text ? `Stuks: ${text}` : 'Stuks: n.v.t.');
      perfSummary.className = 'card-summary ' + (positive ? 'positive' : 'negative');
    }

    calcPerf.addEventListener('click', () => {
      const r = calculatePerformance();
      if(r){
        // save as last calc in UI but not automatically to persist until save pressed
      }
    });

    savePerf.addEventListener('click', () => {
      const obj = calculatePerformance();
      if(!obj || !obj.plan) return;
      // Save the inputs and last summary
      const toSave = {
        plan: obj.plan,
        lastWeek: obj.lastWeek,
        now: obj.now,
        twoWeeks: obj.twoWeeks,
        prognose: obj.prognose,
        verschilPlan: obj.verschilPlan,
        timestamp: Date.now()
      };
      savePerfData(toSave);
      alert('Prestatie opgeslagen.');
      // update summary in header (already set by calculatePerformance -> perfSummaryShow)
    });

    // ---- Popup open/close ----
    openSettings.addEventListener('click', () => {
      popup.style.display = 'flex';
      popup.setAttribute('aria-hidden','false');
      renderStandardList();
      // populate quick-link inputs from storage
      try{
        const q = loadQuick();
        quick2Label.value = q.custom2Label || '';
        quick2Url.value = q.custom2Url || '';
      }catch(e){ /* ignore */ }
    });
    closePopup.addEventListener('click', closePopupFn);
    closeAndSave.addEventListener('click', closePopupFn);

    function closePopupFn(){
      popup.style.display = 'none';
      popup.setAttribute('aria-hidden','true');
    }

    // reset all data
    resetAll.addEventListener('click', () => {
      if(!confirm('WEET JE HET ZEKER? Dit wist alle opgeslagen data (standaard, dagtaken en prestatie).')) return;
      localStorage.removeItem(KEY_STANDARD);
      localStorage.removeItem(KEY_DAILY);
      localStorage.removeItem(KEY_PERF);
      localStorage.removeItem(KEY_QUICK);
      location.reload();
    });

    // ---- Card toggle behavior (collapse / expand) ----
    function toggleCard(headerEl, bodyEl){
      headerEl.addEventListener('click', () => {
        const isOpen = !bodyEl.classList.contains('hidden');
        if(isOpen){
          bodyEl.classList.add('hidden');
          headerEl.setAttribute('aria-expanded','false');
          // Also toggle expanded class on perfCard if this is perfBody
          if(bodyEl === perfBody){
            perfCard.classList.remove('expanded');
          }
        } else {
          bodyEl.classList.remove('hidden');
          headerEl.setAttribute('aria-expanded','true');
          // Also toggle expanded class on perfCard if this is perfBody
          if(bodyEl === perfBody){
            perfCard.classList.add('expanded');
          }
        }
      });
    }
    toggleCard(perfHeader, perfBody);
    toggleCard(tasksHeader, tasksBody);
    // make Codes widget collapsible as well
    if(codesHeader && codesBody) toggleCard(codesHeader, codesBody);
    
    // ---- Initialize saved data to UI ----
  function initFromStorage(){
      // Load perf input values if saved
      const p = loadPerf();
      if(p && Object.keys(p).length){
        if(p.plan) planInput.value = p.plan;
        if(p.lastWeek) lastWeekTotal.value = p.lastWeek;
        if(p.now) currentNow.value = p.now;
        if(p.twoWeeks) twoWeeksAgo.value = p.twoWeeks;
        // Show last summary in header
        if(typeof p.verschilPlan !== 'undefined'){
          const diff = p.verschilPlan;
          const fmt = (n) => Number(n).toLocaleString('nl-NL');
          if(diff > 0){
            perfSummaryShow(`+${fmt(diff)}`, true);
            perfResult.textContent = `Laatste opgeslagen prognose: ${Number(p.prognose).toLocaleString('nl-NL')} (+${fmt(diff)} op plan).`;
            perfResult.className = 'positive';
          } else if(diff < 0){
            perfSummaryShow(`${fmt(diff)}`, false);
            perfResult.textContent = `Laatste opgeslagen prognose: ${Number(p.prognose).toLocaleString('nl-NL')} (${fmt(diff)} op plan).`;
            perfResult.className = 'negative';
          } else {
            perfSummaryShow('0', true);
            perfResult.textContent = `Laatste opgeslagen prognose: ${Number(p.prognose).toLocaleString('nl-NL')} (exact op plan).`;
          }
        }
      } else {
        perfSummaryShow('n.v.t.', true);
      }

      // If no standard tasks exist yet, prefill with common supermarket tasks (optional)
      const standard = loadStandard();
      if(standard.length === 0){
        // voorbeeld-voorbezetting (kan verwijderd worden)
        const sample = [
          { id: simpleId(), text: 'Vakken vullen - brood', done:false, standard:true },
          { id: simpleId(), text: 'Koelers controleren', done:false, standard:true },
          { id: simpleId(), text: 'Kassa wissel klaarzetten', done:false, standard:true }
        ];
        // only auto-add if user hasn't set anything (so they have something to start with)
        saveStandard(sample);
      }

      renderStandardList();
      renderTasks();
      // render quick menu after tasks and standards
      renderQuickMenu();
    }

    // init
    initFromStorage();

    // Update tasks summary when closing popup after changes
    popup.addEventListener('transitionend', () => { renderTasks(); });

    // Close popup on ESC
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && popup.style.display === 'flex') closePopupFn();
    });

    // ensure clicks outside the popup content close it
    popup.addEventListener('click', (e) => {
      if(e.target === popup){
        // don't close on accidental click ‚Äî keep behavior explicit (ask to close)
        if(confirm('Sluit instellingen?')) closePopupFn();
      }
    });

    // ---- Codes storage ----
    function loadCodes(){ try { return JSON.parse(localStorage.getItem(KEY_CODES)) || []; } catch(e){ return []; } }
    function saveCodes(arr){ localStorage.setItem(KEY_CODES, JSON.stringify(arr)); }

    function normalizeNumeric(s){
      return String(s || '').replace(/\D/g,'');
    }

    // add code button handler
    addCodeBtn.onclick = () => {
      const code = codeInput.value.trim();
      const name = codeNameInput.value.trim();
      
      if(!code){
        alert('Voer een code in');
        return;
      }
      
      const codes = loadCodes();
      codes.push({
        id: simpleId(),
        code: code,
        name: name || code
      });
      saveCodes(codes);
      
      // clear inputs
      codeInput.value = '';
      codeNameInput.value = '';
      
      // re-render
      renderCodes();
    };

    // render list of codes with show buttons
    function renderCodes(){
      const codes = loadCodes();
      const container = document.getElementById('codeList');
      if(!container) return;
      container.innerHTML = '';
      
      codes.forEach((c, idx) => {
        const row = document.createElement('li');
        row.className = 'code-row';
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.alignItems = 'center';
        row.style.listStyle = 'none';
        
        const label = document.createElement('span');
        label.style.flex = '1';
        label.innerHTML = `<strong>${c.name || c.code}</strong><br/><span style="font-size:0.85rem; color:#666;">${c.code}</span>`;
        
        // Bekijk QR-code button
        const view = document.createElement('button');
        view.className = 'btn-small';
        view.textContent = 'üîç';
        view.title = 'QR-code bekijken';
        
        view.onclick = () => {
          // Generate QR Code
          const qrcodeContainer = document.getElementById('qrcodeContainer');
          qrcodeContainer.innerHTML = ''; // Clear previous QR code
          new QRCode(qrcodeContainer, {
            text: c.code,
            width: 200,
            height: 200
          });
          
          barcodeContainer.innerHTML = ''; // Clear barcode container
          barcodeTitle.textContent = c.name || c.code;
          barcodePopup.style.display = 'flex';
          barcodePopup.setAttribute('aria-hidden','false');
        };
        
        // Verwijder button
        const del = document.createElement('button');
        del.className = 'btn-small';
        del.textContent = 'üóëÔ∏è';
        del.title = 'Verwijder code';
        
        del.onclick = () => {
          const allCodes = loadCodes();
          allCodes.splice(idx, 1);
          saveCodes(allCodes);
          renderCodes();
        };
        
        row.appendChild(label);
        row.appendChild(view);
        row.appendChild(del);
        container.appendChild(row);
      });
    }

    // Close barcode popup handler
    closeBarcode.onclick = () => {
      barcodePopup.style.display = 'none';
      barcodePopup.setAttribute('aria-hidden','true');
    };

    // ---- Pauze Calculator ----
    function getPauzeMinutes(workMinutes) {
      // Verander van < naar <=
    if (workMinutes <= 255) return 15; // 3.5 tot 4 uur (15 min pauze)
    if (workMinutes <= 390) return 30; // meer dan 4 tot 6 uur (30 min pauze)
    if (workMinutes <= 525) return 45; // meer dan 6 tot 8 uur (45 min pauze)
      return 60; // >= 8 uur
    }

    btnPauze.onclick = () => {
      pauzePopup.setAttribute('aria-hidden', 'false');
      pauzePopup.style.display = 'flex';
      pauzeStart.focus();
    };

    closePauze.onclick = () => {
      pauzePopup.setAttribute('aria-hidden', 'true');
      pauzePopup.style.display = 'none';
    };

    calculatePauze.onclick = () => {
      const start = pauzeStart.value;
      let end = pauzeEnd.value;
      const pauzeMins = Number(pauzePauze.value) || 0;

      if (!start) {
        alert('Voer een starttijd in');
        return;
      }

      // Parse times
      const [startH, startM] = start.split(':').map(Number);
      const startMins = startH * 60 + startM;

      let endMins;
      if (end) {
        const [endH, endM] = end.split(':').map(Number);
        endMins = endH * 60 + endM;
      } else {
        // Bereken eindtijd: starttijd + pauze + werktijd voor de gegeven pauze
        // Werk backwards: als je 15 min pauze hebt, hoeveel werk je dan?
        // 3.5 tot 4 uur = 15 min pauze
        let workMinutes;
        if (pauzeMins === 0) workMinutes = 210; // 3.5 uur (geen pauze)
        else if (pauzeMins === 15) workMinutes = 240; // 4 uur
        else if (pauzeMins === 30) workMinutes = 360; // 6 uur
        else if (pauzeMins === 45) workMinutes = 480; // 8 uur
        else if (pauzeMins === 60) workMinutes = 480; // 8 uur minimum
        else {
          alert('Voer een geldige pauze in (0, 15, 30, 45 of 60 minuten)');
          return;
        }
        endMins = startMins + workMinutes + pauzeMins;
      }

      // Bereken werkminuten (exclusief pauze)
      const totalMins = endMins - startMins;
      const workMins = totalMins - pauzeMins;

      // Bepaal welke pauze te tonen
      let displayPauze;
      if (!pauzeEnd.value && pauzePauze.value) {
        // Als gebruiker pauze invoerde en wij eindtijd berekenden: toon de ingevoerde pauze
        displayPauze = pauzeMins;
      } else {
        // Anders: bereken pauze aan de hand van werktijd
        displayPauze = getPauzeMinutes(workMins);
      }

      // Format times
      const formatTime = (mins) => {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      };

      const endTime = formatTime(endMins);
      const workHours = (workMins / 60).toFixed(2);

      pauzeResultText.innerHTML = `
        <div>Eindtijd: <strong>${endTime}</strong></div>
        <div style="margin-top:8px;">Werktijd: <strong>${workHours} uur</strong></div>
        <div style="margin-top:8px;">Pauze nodig: <strong>${displayPauze} minuten</strong></div>
      `;
      pauzeResult.style.display = 'block';
    };

    // initialize codes on load
    (function initCodes(){ renderCodes(); })();

    // ---- Service Worker Registration (PWA) ----
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker registered', reg))
        .catch(err => console.log('Service Worker registration failed', err));
    }

    // ---- Install Prompt ----
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Optioneel: toon een "Install" knop
    });
  </script>
</body>
</html>
